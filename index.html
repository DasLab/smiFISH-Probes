<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.18.0/full/pyodide.js"></script>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  </head>
<!-- This example requires Tailwind CSS v2.0+ -->
<meta charset="UTF-8">
<div class="min-h-screen bg-white">
  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <p style="font-size:40px">&#x1F41F;</p>
          </div>
          <div class="hidden sm:-my-px sm:ml-6 sm:flex sm:space-x-8">
            <!-- Current: "border-indigo-500 text-gray-900", Default: "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" -->
            <a href="#" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" aria-current="page">
              Probe Designer
            </a>

            <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              About
            </a>

            <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Projects
            </a>

            <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Calendar
            </a>
          </div>
        </div>
            <!-- Heroicon name: outline/bell -->

          <!-- Profile dropdown -->

            <!--
              Dropdown menu, show/hide based on menu state.

              Entering: "transition ease-out duration-200"
                From: "transform opacity-0 scale-95"
                To: "transform opacity-100 scale-100"
              Leaving: "transition ease-in duration-75"
                From: "transform opacity-100 scale-100"
                To: "transform opacity-0 scale-95"
            -->
            <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">

            </div>
        <div class="-mr-2 flex items-center sm:hidden">
          <!-- Mobile menu button -->

            <!--
              Heroicon name: outline/menu

              Menu open: "hidden", Menu closed: "block"
            -->
            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <!--
              Heroicon name: outline/x

              Menu open: "block", Menu closed: "hidden"
            -->
            <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile menu, show/hide based on menu state. -->
    <div class="sm:hidden" id="mobile-menu">
      <div class="pt-2 pb-3 space-y-1">
        <!-- Current: "bg-indigo-50 border-indigo-500 text-indigo-700", Default: "border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800" -->
        <a href="#" class="bg-indigo-50 border-indigo-500 text-indigo-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium" aria-current="page">
          Probe Designer
        </a>

        <a href="#" class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
          Team
        </a>

        <a href="#" class="border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
          Projects
        </a>

      </div>
    </div>
  </nav>

  <div class="py-10">
    <header>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold leading-tight text-gray-900">
          Automated smFISH/smiFISH probe designer
        </h1>
      </div>
    </header>
    <main>
      <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
        <label for="target sequence" class="block text-sm font-medium text-gray-700">Target RNA Sequence:</label>
        <div class="mt-1">
        <input type="text" id="target_sequence" class="overflow-clip shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md" value="AAAGACAGGCCCUCAGAGUCCGACGAGCUUCUCAGAGUCCGACGAGCUUCAGACCAUCCAAGAAGAUCCCACAGCAGCUUCCGAAGGCCUGGAUGUGAUGGCAUCACAGAAGAGACCCUCACAGCGACACGGGUCCAAGUACUUGGCCACAGCAAGUACCAUGGACCAUGCCCGGCAUGGCUUCCUCCCAAGGCACAGAGACACGGGCAUCCUUGACUCCAUCGGGCGCUUCUUUAGCGGUGACAGGGGUGCGCCCAAGCGGGGCUCUGGCAAGGUACCCUGGCUAAAGCAGAGCCGGAGCCCUCUGCCUUCUCAUGCCCGCAGCCGUCCCGGGCUGUGCCACAUGUACAAGGACUCACACACAAGAACUACCCACUACGGCUCCCUGCCCCAGAAGUCGCAGAGGACCCAAGAUGAAAACCCAGUAGUCCACUUCUUCAAGAACAUUGUGACACCUCGUACACCCCCUCCAUCCCAAGGAAAGGGGAGAGGCCUGUCCCUCAGCAGAUUUAGCUGGGGGGCCGAGGGGCAGAAGCCAGGAUUUGGCUACGGAGGCAGAGCUUCCGACUAUAAAUCGGCUCACAAGGGAUUCAAGGGGGCCUACGACGCCCAGGGCACGCUUUCCAAAAUCUUUAAGCUGGGAGGAAGAGACAGCCGCUCUGGAUCUCCCAUGGCAAGACGCUGAGAGCCUCCCUGCUCAGCCUUCCCGAAUCCUGCCCUCGGCUUCUUAAUAUAACUGCCUUAAACGUUUAAUUCUACUUGCACCAAAUAGCUAGUUAGAGCAGACCCUCUCUUAAUCCCGUGGGGCUGUGAACGCGGCGGGGCCAGGCCCACGGCACCCUGACUGGCUAAAACUGUUUGUCCCUUUUUAUUUGAAGAUUGAGUUUCCUCGGGGUCUUCUCUGCCCCGACUUGCUCCCCGUGUACCUUGGUCGACUCCGGAGGUUCAGGUGCACGGACACCCUUUCAAGUUCACCCCUACUCCAUCCUCAGACUUUCUUUUCACGGCGAGGCGCACCCCUCCAGCUUCCGUGGGCACUGCGGAUAGACAGGCACACCGCCAAGGAGCCAGAGAGCAUGGCGCAGGGGACUGUGUGGUCCAGGCUUCCUUUGUUUUCUUUCCCCUAAAGAGCUUUGUUUUUCCUAACAGGAUCAGACAGUCUUGGAGUGGCUUACACAACGGGGGCUUGUGGUAUGUGAGCACAGGCUGGGCAGCUGUGAGAGUCCAGAGUGGGGUGGCCCUGGGGACGCUUCCAGGCCAGCGGUUCCCUGCACCCCACCAGCUGAUUUCGAGCGUGGCAGAGGGAAGGAAAGGGGCGAGCGGGCUGGGCAAUGGACCCGACAGGAAACGGGGACUUAGGGGAACACGCUGGAGAUGCCAUGUGUGGCUGCCGAAGGUCACCAUCUCUCCUCAGUGGCUCCCCAGAGCAGGUGCUUUUAAGAACCCUGUUUCCUCUCAGAGCCCAGGGAGAGUCCAAGGACAUGGCGCAUCAGGAAGUGGGACUGCAGGAGUUCUCUGGUGGCCUCGUGCUGUCCCUCUGGCCACUUCUCACUUUAGGGUGGUCAGCGGCAGCUCGCCAUGGCAGUGCCCAUUGGUGCACACUAACCUCAGUGGAAAAGUAACCAUUCCCUGCCUCUUAGAAAGAACUCAUUCUUAGUUUUAGGAGGGUUCCUGUCGCUGAAUCAAGUCGCUGCCCUGGAUGCAGGGCUGGCCUGGGCGACCCUCCAGGGAUGAGGAGCUCAGAAUUCCAGUCUUCUAAUGUCCACGGACACCUCCCCAUCCCUCUAACGUACUGACUAUGUCUUUUGAUUUAGCAUGUCUUCUAUAGACCUUCCAAAGAGACCCACACUGGCACUGUCACCCCCUAGGAGGGAAGGUGAUGGUUGAUGUAGCCCGACGCGCAUCUUGUUAAUCCGUUCUAAUUCCGAGGAGAGUGUGGGUUUAAGAUAACACCUAUUAAUGCAUUGCCACAAUAAUGUGGGGGUAAGAGAAACGCAGGGACGAAACUUCCAGAAACAAACCCUCCAGAUCGUUCCACAGGAGUGUUCGCCCUCCGGUGUGACUGAACGACCGACCUUGCCCAUGGCUUCAUCCAGACAGCACAGCUGCAGUAUGGCUGGACAGAAGCACCUACUGUUCUUGGAUAUUGAAAUAAAAUAAUAAACUUGCAAUGAUCUUUG"/>
	</div>

        <label for="target name" class="block text-sm font-medium text-gray-700">Name of Target RNA Sequence:</label>
        <input type="text" id="target_name" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" value="MPB"/>

        <lable for="FLAP sequence" class="block text-sm font-medium text-gray-700">Enter FLAP sequence:</lable>
        <input type="text" id="FLAPSequence" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" value="CCTCCTAAGTTTCGAGCTGGACTCAGTG" />

        <lable for="FLAP sequence" class="block text-sm font-medium text-gray-700">Enter FLAP name:</lable>
        <input type="text" id="FLAPName" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" value="X" />

        <lable for="FLAP sequence" class="block text-sm font-medium text-gray-700">Minimum probe length:</lable>
        <input type="number" id="probemin" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" value="20" />

        <lable for="FLAP sequence" class="block text-sm font-medium text-gray-700">Maximum probe length:</lable>
        <input type="number" id="probemax" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" value="30" />

        <lable for="FLAP sequence" class="block text-sm font-medium text-gray-700">Acceptable probe length (maximum):</lable>
        <input type="number" id="AcceptableProbeMax" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" value="60" />
        
        <button id="make-probe-button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Make Probes!</button>

        <button type="button" id="download-csv-button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <!-- Heroicon name: solid/mail -->
        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
        </svg>
        Download CSV File
        </button>

        <button type="button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Download Excel File</button>

        <!-- <textarea id="output" style="width: 100%;" rows="6" disabled></textarea> -->
        <div id="output"></div>
        <div id="hidden_df_output" style="display: none;"></div>
        <div id="hidden_csv_output" style="display: none;"></div>

        <div class="px-4 py-8 sm:px-0">
          <div class="border-4 border-dashed border-gray-200 rounded-lg h-96"></div>
        </div>

        <script>

              console.log('Starting...')

              var probe_min = document.getElementById("probemin").value;
              document.getElementById("probemin").innerHTML = probe_min;


              // init Pyodide
              async function main() {
                let pyodide = await loadPyodide({
                  indexURL: "https://cdn.jsdelivr.net/pyodide/v0.18.0/full/",
                });
                return pyodide;
              }



              let pyodideReadyPromise = main();


              let python = `
              import pandas as pd
              import numpy as np
              import js
              
              `;

              let probe_design_python = `

              # Import information from form
              target_sequence = js.document.getElementById("target_sequence").value
              print(target_sequence)

              target_name = js.document.getElementById("target_name").value
              print(target_name)

              probe_min = js.document.getElementById("probemin").value
              print(probe_min)

              probe_max = js.document.getElementById("probemax").value
              print(probe_max)

              FLAP_sequence = js.document.getElementById("FLAPSequence").value
              print(FLAP_sequence)

              FLAP_name = js.document.getElementById("FLAPName").value
              print(FLAP_name)


              # Flip the inputed target RNA and replace bases to create complement strand
              reverse = target_sequence[::-1]
              comp = target_sequence.lower()[::-1].replace("g", "C").replace("c", "G").replace("t", "A").replace("a", "T").replace("u", "A")

              # Split complement strand (comp) into all possible probes between range (ex. 20-30 bases long)
              split_probes = []
              for n in range(int(probe_min), int(probe_max)): 
                for i in range(0, len(comp), n):
                  probe = comp[i:i + n]

                  # If length of probe is shorter than minimum range, remove from list
                  if len(probe) > 20:
                    split_probes.append(probe)

              # Inputed names/sequences for FLAP and target RNA
              final_sequence = [probe + FLAP_sequence for probe in split_probes]

              # List of GC content filter
              gc_filter = ['GC_filter']

              # List of 5 PNAS rules for optimum probe performance
              filters = ['pnas1', 'pnas2', 'pnas3', 'pnas4', 'pnas5']

              # PNAS 1: Filter out nucleotide compositions with A < 28%
              def pnas_filter_1(probe_sequence):
                percent_a = probe_sequence.count('A')/len(probe_sequence)
                return 0.28 < percent_a

              # PNAS 2: Remove anything with AAAA stacks
              def pnas_filter_2(probe_sequence):
                A_stack = 'AAAA'
                if A_stack in probe_sequence:
                  return False 
                else:
                  return True

              # PNAS 3: Enforce C composition of between 22-28%
              def pnas_filter_3(probe_sequence):
                percent_c = probe_sequence.count('C')/len(probe_sequence)
                return 0.22 < percent_c < 0.28

              # PNAS 4: No CCCC stacks in any 6 consecutive nucleotides in the first 12 positions
              def pnas_filter_4(probe_sequence):
                C_stack = 'CCCC'
                sequence_subset = probe_sequence[0:12]
                if C_stack in sequence_subset:
                  return False
                else:
                  return True 

              # PNAS 5: No 4 nonconsecutive Cs in any 6 consecutive nucleotides in the first 12 positions
              def pnas_filter_5(probe_sequence):
                sequence_subset = probe_sequence[0:12]
                for p in range(6):
                  if sequence_subset[p:p+6].count('C') >= 4:
                    return False
                return True

              # Calculate the max probe length (without FLAP sequence)
              def max_probe(FLAP_sequence, acceptable_max):
                calculate_max_probe = acceptable_max - len(FLAP_sequence)
                return calculate_max_probe

              # Calculate deltaG using Nearest-Neighbor Parameters
              def deltaG1(probe_sequence):
                table = {"AA":0.2, "AC":-1.4, "AG":-0.4, "AT":-0.4,
                "CA":-1.6, "CC":-2.3, "CG":-1.4, "CT":-1.3,
                "GA":-1.4, "GC":-2.0, "GG":-1.7, "GT":-1.5, 
                "TA":-0.5, "TC":-1.5, "TG":-1.2, "TT":-0.7}

                for p in range(len(probe_sequence)):
                  # Add deltaG of pairing, then next pairing including the last base-pair (ex. ACGA = AC, CG, GA)
                  list_of_pairs = [probe_sequence[p:2 + p] for p in range(0, len(probe_sequence))]
                  # Delete last element of list, not a paired base
                  list_of_pairs.pop()
                  if len(list_of_pairs) > 0:
                    # Make a series using the dictonary of calculated deltaG's
                    C = pd.Series(list_of_pairs).map(table)
                    D = list(C)
                    return sum(D)
                  else:
                    return 'Error'

              # Calculate GC percentage
              def GC_percent(probe_sequence):
                G = probe_sequence.count('G')
                C = probe_sequence.count('C')
                percent_GC = (G + C)/len(probe_sequence)
                return percent_GC

              # Filter for GC content between 40% and 60%
              def GC_filter(probe_sequence):
                  return 0.40 <= GC_percent(probe_sequence) <= 0.60

              # Find start index of probe within complementary strand
              def start_index(probe_sequence, comp):
                if probe_sequence in comp:
                  start = comp.find(probe_sequence)
                  return start

                return 'Error'

              # Find end index of probe within complementary strand
              def end_index(probe_sequence, comp):
                if probe_sequence in comp:
                  end = comp.find(probe_sequence)
                  end += len(probe_sequence) - 1
                  return end

                return 'Error'

              # Well position for ordering .xlsx
              def well_position_list(n):
                  well_y = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']
                  newrow = [[i+str(j) for j in range(1,13)] for i in well_y]
                  well_name = [j for i in newrow for j in i]
                  well_name_array = np.array(well_name)
                  
                  well_names_output = []
                  for p in range(n):
                      well_names_output.append(well_name_array[p % len(well_name_array)])

                  return well_names_output


              # Takes in two intervals, and returns boolean if they overlap or not
              def overlapping_intervals(a, b):
                  if a[0] < b[0]:
                      first = a
                      second = b
                  elif a[0] == b[0]:
                      return True
                  else:
                      first = b
                      second = a
                      
                  return first[1] > second[0]

              # Takes start and end range of probe and compares it to start and end of other, lower-ranking probes
              def check_probe_fits(probe_candidate, probe_list):
                for probe in probe_list:
                  if overlapping_intervals([probe['start'], probe['end']], [probe_candidate['start'], probe_candidate['end']]):
                    return False
                return True

              # Find probes that are nonoverlapping based on their ranking of distance away from the median
              def find_nonoverlapping_probes_around_median(df):
                  
                  # Calculate median delta G
                  median = df['deltaG'].median()
                  
                  # Order rows in probes dataframe by distance to median with Pandas-function
                  for probe in range(len(df['deltaG'])):
                      result_index = df['deltaG'].sub(median).abs().argsort()[0:].tolist()
                      ordered_rows = df.iloc[result_index]

                  # Iteratively build list of non-overlapping probes around the median
                  final_probe_list = [df.iloc[result_index[0]]]
                  # Probe vs. all other probe_candidates based on ranking
                  for index in result_index[1:]:
                      probe_candidate = df.iloc[index]
                      if check_probe_fits(probe_candidate, final_probe_list):
                          final_probe_list.append(probe_candidate)
                  
                  return pd.DataFrame(final_probe_list)

              df = pd.DataFrame()

              # Adding columns to main DataFrame (boolean --> integers)
              df['probe_sequence'] = split_probes
              df['probe_length'] = df['probe_sequence'].apply(len)
              df['start'] = df['probe_sequence'].apply(start_index, comp=comp)
              df['end'] = df['probe_sequence'].apply(end_index, comp=comp)
              df['pnas1'] = df['probe_sequence'].apply(pnas_filter_1).astype(int)
              df['pnas2'] = df['probe_sequence'].apply(pnas_filter_2).astype(int)
              df['pnas3'] = df['probe_sequence'].apply(pnas_filter_3).astype(int)
              df['pnas4'] = df['probe_sequence'].apply(pnas_filter_4).astype(int)
              df['pnas5'] = df['probe_sequence'].apply(pnas_filter_5).astype(int)
              df['deltaG'] = df['probe_sequence'].apply(deltaG1)
              df['GC'] = df['probe_sequence'].apply(GC_percent)
              df['GC_filter'] = df['probe_sequence'].apply(GC_filter).astype(int)
              df['target_name'] = target_name
              df['FLAP_name'] = FLAP_name
              df['FLAP_sequence'] = FLAP_sequence
              df['final_sequence'] = final_sequence


              # Given dataframe and filters, return filtered dataframes
              def filter_df(df, filters):
                  return df[df[filters].all(1)]

              # NOTE: Requiers 
              def iteratively_find_probe_set(df, filters, gc_filter):
                  
                  filtered_out_counts = {}

                  for f in filters:
                      filtered_out_count = len(df) - df[f].sum()
                      filtered_out_counts[f] = filtered_out_count

                  ordered_filters = sorted(filtered_out_counts, key=filtered_out_counts.get, reverse=False)
                  
                  gc_filter_on = df[df[gc_filter].all(1)]
                  
                  median_and_filters = find_nonoverlapping_probes_around_median(filter_df(gc_filter_on, filters))

                  while len(median_and_filters) < 20:
                      ordered_filters.pop(0)
                      filtered_filters_df = filter_df(gc_filter_on, ordered_filters)
                      median_and_filters = find_nonoverlapping_probes_around_median(filter_df(gc_filter_on, ordered_filters))
                      
                      if len(median_and_filters) >= 20:
                          break
                  
                  if len(median_and_filters) >= 20:
                      print('Found {} probes using filters {}'.format(len(median_and_filters), ' '.join(ordered_filters)))
                      return median_and_filters
                  else:
                      raise ValueError('Not enough probes even with all filters off')

              # Create DataFrame with GC filter and using filters
              fdf = iteratively_find_probe_set(df, filters, gc_filter)


              # Final sequence name (target name + FLAP name + ranking number)
              fdf_index_reset = fdf.reset_index()
              fdf_index = fdf_index_reset.index.map(str)
              final_sequence_name = (target_name + '-' + FLAP_name + '-' + fdf_index)

              # Output of final, filtered DataFrame
              fdf['final_sequence_name'] = final_sequence_name
              fdf['well_position'] = well_position_list(len(fdf))
              print(fdf)
              `;

              let dataframe_py_to_html = `
              fdf.to_html()
              `;

              let dataframe_py_to_csv = `
              fdf.to_csv()
              `;

              let dataframe_py_to_excel = `
              fdf.to_excel()
              `;

              //URL: https://ourcodeworld.com/articles/read/189/how-to-create-a-file-and-generate-a-download-with-javascript-in-the-browser-without-a-server
              function download(filename, text) {
                  var element = document.createElement('a');
                  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                  element.setAttribute('download', filename);

                  element.style.display = 'none';
                  document.body.appendChild(element);

                  element.click();

                  document.body.removeChild(element);
              }

              async function evaluatePython() {
                let pyodide = await pyodideReadyPromise;
                // try {
                //   let output = pyodide.runPython(python);
                //   addToOutput(output);
                // } catch (err) {
                //   addToOutput(err);
                // }

                pyodide.loadPackage(['pandas']).then(() => {

                  console.log(pyodide.runPython(python))


                  document.getElementById('make-probe-button').onclick = function() {
                    console.log('Make Probes button pressed')
                    console.log(pyodide.runPython(probe_design_python))

                    document.getElementById('hidden_df_output').innerHTML = pyodide.runPython(dataframe_py_to_html)
                    console.log(pyodide.runPython(dataframe_py_to_html))

					function edit_df() {
						var df_hidden = document.getElementById("hidden_df_output");
						var df_text = df_hidden.innerHTML;
						let edited = df_text.replace('<table border="1" class="dataframe">', '<table class="min-w-full divide-y divide-gray-200">');
						document.getElementById('output').innerHTML = edited;
						return edited
					}
					
					console.log(edit_df());
                    

                  }
                  

                  document.getElementById('download-csv-button').onclick = function() {
                    console.log('CSV button pressed')
                    console.log(pyodide.runPython(dataframe_py_to_csv))
                    document.getElementById('hidden_csv_output').innerHTML = pyodide.runPython(dataframe_py_to_csv)
                    var csv_text = document.getElementById('hidden_csv_output').textContent;
                    download('filename.csv', csv_text)

                  }

                  // document.getElementById('download-excel-button').onclick = function() {
                  //   console.log('Excel button pressed')
                  //   console.log(pyoide.runPython(dataframe_py_to_excel))
                  
                  

                })

              }

              evaluatePython()


            </script>
          </body>
          </div>
        <!-- /End replace -->
      </div>
    </main>
  </div>
</div>
</html>